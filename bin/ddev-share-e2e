#!/usr/bin/env bash

PROJECT_HOST=$(ddev wp option get home | tr -d '\r' | awk -F'^http[s]?://' '{print $2}')
ddev share >/dev/null &
NGROK_PID=$!
ngrok-url(){
    curl -s localhost:4040/api/tunnels | jq -r .tunnels[0].public_url | awk -F'^http[s]?://' '{print $2}'
}
wp-replace(){
  echo "Replacing ${1} with ${2}"
  ddev wp search-replace "${1}" "${2}" --all-tables --precise --recurse-objects
}

echo "ngrok started with PID ${NGROK_PID}"

echo "Waiting a few seconds for the service to come up"
sleep 3
NGROK_HOST=$(ngrok-url)
wp-replace "${PROJECT_HOST}" "${NGROK_HOST}"
echo "Change the baseUrl to 'https://${NGROK_HOST}'"
#this sets the variable for the next step
echo "BASEURL=$BASEURL" >> $GITHUB_ENV
echo "Your site is now reachable at https://${NGROK_HOST}"
